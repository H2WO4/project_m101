<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö¶ CityFlow Analytics - Dashboard Temps R√©el</title>
    
    <!-- Leaflet CSS for OpenStreetMap -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            overflow-x: hidden;
        }

        .header {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4ade80;
            box-shadow: 0 0 10px #4ade80;
            animation: pulse 2s infinite;
        }

        .status-indicator.disconnected {
            background: #ef4444;
            box-shadow: 0 0 10px #ef4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            padding: 20px;
            height: calc(100vh - 80px);
        }

        .map-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .map-overlay h3 {
            margin-bottom: 10px;
            font-size: 16px;
            color: #fff;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
            font-size: 13px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-label {
            font-size: 13px;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            display: flex;
            align-items: baseline;
            gap: 5px;
        }

        .stat-unit {
            font-size: 16px;
            opacity: 0.7;
        }

        .stat-trend {
            font-size: 14px;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .trend-up {
            color: #4ade80;
        }

        .trend-down {
            color: #ef4444;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            flex: 1;
        }

        .chart-title {
            font-size: 16px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .alerts-container {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-height: 250px;
            overflow-y: auto;
        }

        .alert-item {
            background: rgba(239, 68, 68, 0.2);
            border-left: 4px solid #ef4444;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            font-size: 13px;
            animation: slideIn 0.5s ease;
        }

        .alert-item.warning {
            background: rgba(251, 191, 36, 0.2);
            border-left-color: #fbbf24;
        }

        .alert-item.info {
            background: rgba(59, 130, 246, 0.2);
            border-left-color: #3b82f6;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .alert-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }

        #trafficChart, #emissionsChart {
            width: 100%;
            height: 200px;
        }

        .prediction-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(139, 92, 246, 0.9);
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            üö¶ CityFlow Analytics
        </div>
        <div class="connection-status">
            <div class="status-indicator" id="statusIndicator"></div>
            <span id="statusText">Connect√© au serveur</span>
        </div>
    </div>

    <div class="main-container">
        <!-- Section Carte -->
        <div class="map-section">
            <div class="map-overlay">
                <h3>L√©gende</h3>
                <div class="legend-item">
                    <div class="legend-color" style="background: #22c55e;"></div>
                    <span>Fluide (&lt; 30 km/h)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fbbf24;"></div>
                    <span>Dense (30-50 km/h)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ef4444;"></div>
                    <span>Embouteill√© (&gt; 50 km/h)</span>
                </div>
            </div>
            <div class="prediction-badge" id="predictionBadge">
                üîÆ Pr√©diction: Embouteillage dans 25 min
            </div>
            <div id="map"></div>
        </div>

        <!-- Panneau Droit -->
        <div class="right-panel">
            <!-- Stats en temps r√©el -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">V√©hicules Actifs</div>
                    <div class="stat-value">
                        <span id="vehicleCount">0</span>
                    </div>
                    <div class="stat-trend trend-up" id="vehicleTrend">
                        ‚Üë +12%
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Vitesse Moyenne</div>
                    <div class="stat-value">
                        <span id="avgSpeed">0</span>
                        <span class="stat-unit">km/h</span>
                    </div>
                    <div class="stat-trend trend-down" id="speedTrend">
                        ‚Üì -8%
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">√âmissions CO‚ÇÇ</div>
                    <div class="stat-value">
                        <span id="emissions">0</span>
                        <span class="stat-unit">kg</span>
                    </div>
                    <div class="stat-trend trend-down" id="emissionsTrend">
                        ‚Üì -23%
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Temps Gain Moyen</div>
                    <div class="stat-value">
                        <span id="timeSaved">0</span>
                        <span class="stat-unit">min</span>
                    </div>
                    <div class="stat-trend trend-up" id="timeTrend">
                        ‚Üë +15%
                    </div>
                </div>
            </div>

            <!-- Graphique Trafic -->
            <div class="chart-container">
                <div class="chart-title">üìä Densit√© de Trafic (30 derni√®res minutes)</div>
                <svg id="trafficChart"></svg>
            </div>

            <!-- Graphique √âmissions -->
            <div class="chart-container">
                <div class="chart-title">üå± R√©duction d'√âmissions</div>
                <svg id="emissionsChart"></svg>
            </div>

            <!-- Alertes -->
            <div class="alerts-container">
                <div class="chart-title">‚ö†Ô∏è Alertes & Pr√©dictions</div>
                <div id="alertsList"></div>
            </div>
        </div>
    </div>

    <!-- Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <script>
        // =========================
        // CONFIGURATION
        // =========================
        const WS_URL = 'ws://localhost:8080/ws'; // URL WebSocket backend
        const MAP_CENTER = [48.8566, 2.3522]; // Paris coordinates
        const MAP_ZOOM = 13;

        // =========================
        // WEBSOCKET CONNECTION
        // =========================
        let ws;
        let reconnectInterval;

        function connectWebSocket() {
            ws = new WebSocket(WS_URL);
            
            ws.onopen = () => {
                console.log('WebSocket connect√©');
                updateConnectionStatus(true);
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('Message re√ßu:', data);
                handleIncomingData(data);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateConnectionStatus(false);
            };
            
            ws.onclose = () => {
                console.log('WebSocket d√©connect√©');
                updateConnectionStatus(false);
                reconnectInterval = setTimeout(connectWebSocket, 5000);
            };
        }

        function handleIncomingData(data) {
            const { type, data: msgData } = data;
            
            if (type === 'init') {
                console.log('Donn√©es initiales re√ßues');
                msgData.vehicles.forEach(v => addOrUpdateVehicle(v));
                updateStats(msgData.stats);
            } else if (type === 'update') {
                msgData.vehicles.forEach(v => addOrUpdateVehicle(v));
                updateStats(msgData.stats);
            } else if (type === 'alerts') {
                msgData.forEach(alert => addAlert(alert.message, alert.severity));
            } else if (type === 'predictions') {
                console.log('Pr√©dictions:', msgData);
            }
        }

        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            if (connected) {
                indicator.classList.remove('disconnected');
                text.textContent = 'Connect√© au serveur';
            } else {
                indicator.classList.add('disconnected');
                text.textContent = 'D√©connect√© - Reconnexion...';
            }
        }

        // =========================
        // MAP INITIALIZATION
        // =========================
        const map = L.map('map').setView(MAP_CENTER, MAP_ZOOM);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // Stockage des marqueurs et routes
        const vehicleMarkers = new Map();
        const routeLines = new Map();
        const trafficSegments = [];

        // =========================
        // DATA VISUALIZATION
        // =========================
        let trafficData = [];
        let emissionsData = [];

        function initCharts() {
            // Configuration initiale des graphiques D3.js
            createTrafficChart();
            createEmissionsChart();
        }

        function createTrafficChart() {
            const svg = d3.select('#trafficChart');
            const width = svg.node().getBoundingClientRect().width;
            const height = 200;
            const margin = { top: 10, right: 10, bottom: 30, left: 40 };

            svg.attr('width', width).attr('height', height);

            // Axes
            const xScale = d3.scaleTime()
                .domain([new Date() - 30 * 60000, new Date()])
                .range([margin.left, width - margin.right]);

            const yScale = d3.scaleLinear()
                .domain([0, 100])
                .range([height - margin.bottom, margin.top]);

            // Ligne
            const line = d3.line()
                .x(d => xScale(d.time))
                .y(d => yScale(d.value))
                .curve(d3.curveMonotoneX);

            // Axes
            svg.append('g')
                .attr('class', 'x-axis')
                .attr('transform', `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(xScale).ticks(5).tickFormat(d3.timeFormat('%H:%M')))
                .attr('color', '#fff');

            svg.append('g')
                .attr('class', 'y-axis')
                .attr('transform', `translate(${margin.left},0)`)
                .call(d3.axisLeft(yScale))
                .attr('color', '#fff');

            // Path pour la ligne
            svg.append('path')
                .attr('class', 'traffic-line')
                .attr('fill', 'none')
                .attr('stroke', '#4ade80')
                .attr('stroke-width', 2);
        }

        function updateTrafficChart(newValue) {
            trafficData.push({
                time: new Date(),
                value: newValue
            });

            // Garde seulement les 30 derni√®res minutes
            const thirtyMinutesAgo = new Date() - 30 * 60000;
            trafficData = trafficData.filter(d => d.time > thirtyMinutesAgo);

            const svg = d3.select('#trafficChart');
            const width = svg.node().getBoundingClientRect().width;
            const height = 200;
            const margin = { top: 10, right: 10, bottom: 30, left: 40 };

            const xScale = d3.scaleTime()
                .domain([new Date() - 30 * 60000, new Date()])
                .range([margin.left, width - margin.right]);

            const yScale = d3.scaleLinear()
                .domain([0, 100])
                .range([height - margin.bottom, margin.top]);

            const line = d3.line()
                .x(d => xScale(d.time))
                .y(d => yScale(d.value))
                .curve(d3.curveMonotoneX);

            svg.select('.traffic-line')
                .datum(trafficData)
                .transition()
                .duration(300)
                .attr('d', line);

            // Update axes
            svg.select('.x-axis')
                .transition()
                .duration(300)
                .call(d3.axisBottom(xScale).ticks(5).tickFormat(d3.timeFormat('%H:%M')));
        }

        function createEmissionsChart() {
            const svg = d3.select('#emissionsChart');
            const width = svg.node().getBoundingClientRect().width;
            const height = 200;
            const margin = { top: 10, right: 10, bottom: 30, left: 40 };

            svg.attr('width', width).attr('height', height);

            const data = [
                { label: 'Avant', value: 100, color: '#ef4444' },
                { label: 'Apr√®s', value: 77, color: '#4ade80' }
            ];

            const xScale = d3.scaleBand()
                .domain(data.map(d => d.label))
                .range([margin.left, width - margin.right])
                .padding(0.3);

            const yScale = d3.scaleLinear()
                .domain([0, 120])
                .range([height - margin.bottom, margin.top]);

            // Barres
            svg.selectAll('.bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('class', 'bar')
                .attr('x', d => xScale(d.label))
                .attr('y', height - margin.bottom)
                .attr('width', xScale.bandwidth())
                .attr('height', 0)
                .attr('fill', d => d.color)
                .attr('rx', 5)
                .transition()
                .duration(1000)
                .attr('y', d => yScale(d.value))
                .attr('height', d => height - margin.bottom - yScale(d.value));

            // Labels
            svg.selectAll('.label')
                .data(data)
                .enter()
                .append('text')
                .attr('class', 'label')
                .attr('x', d => xScale(d.label) + xScale.bandwidth() / 2)
                .attr('y', d => yScale(d.value) - 5)
                .attr('text-anchor', 'middle')
                .attr('fill', '#fff')
                .attr('font-size', '14px')
                .attr('font-weight', 'bold')
                .text(d => d.value + '%');

            // Axes
            svg.append('g')
                .attr('transform', `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(xScale))
                .attr('color', '#fff');

            svg.append('g')
                .attr('transform', `translate(${margin.left},0)`)
                .call(d3.axisLeft(yScale).ticks(5))
                .attr('color', '#fff');
        }

        // =========================
        // ALERTS MANAGEMENT
        // =========================
        function addAlert(message, type = 'warning') {
            const alertsList = document.getElementById('alertsList');
            const alertItem = document.createElement('div');
            alertItem.className = `alert-item ${type}`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString('fr-FR');
            
            alertItem.innerHTML = `
                <div>${message}</div>
                <div class="alert-time">${timeString}</div>
            `;
            
            alertsList.insertBefore(alertItem, alertsList.firstChild);
            
            // Limite √† 10 alertes
            while (alertsList.children.length > 10) {
                alertsList.removeChild(alertsList.lastChild);
            }
        }

        // =========================
        // VEHICLE MANAGEMENT
        // =========================
        function getColorByDirection(direction) {
            const dir = direction % 360;
            if (dir >= 337.5 || dir < 22.5) return '#ef4444';      // N - Rouge
            if (dir >= 22.5 && dir < 67.5) return '#f97316';       // NE - Orange
            if (dir >= 67.5 && dir < 112.5) return '#fbbf24';      // E - Jaune
            if (dir >= 112.5 && dir < 157.5) return '#84cc16';     // SE - Vert clair
            if (dir >= 157.5 && dir < 202.5) return '#22c55e';     // S - Vert
            if (dir >= 202.5 && dir < 247.5) return '#06b6d4';     // SO - Cyan
            if (dir >= 247.5 && dir < 292.5) return '#3b82f6';     // O - Bleu
            return '#8b5cf6';                                        // NO - Violet
        }

        function addOrUpdateVehicle(vehicleData) {
            const { id, lat, lng, speed, status, direction, directionName = '? UNK' } = vehicleData;
            
            const color = getColorByDirection(direction);

            const icon = L.divIcon({
                html: `<div style="background: ${color}; width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 8px rgba(0,0,0,0.4);"></div>`,
                className: '',
                iconSize: [14, 14],
                iconAnchor: [7, 7]
            });

            if (vehicleMarkers.has(id)) {
                const marker = vehicleMarkers.get(id);
                marker.setLatLng([lat, lng]);
                marker.setIcon(icon);
            } else {
                const marker = L.marker([lat, lng], { icon })
                    .bindPopup(`
                        <b>V√©hicule #${id}</b><br>
                        Vitesse: ${speed.toFixed(1)} km/h<br>
                        Statut: ${status}<br>
                        Direction: ${directionName} (${direction}¬∞)
                    `)
                    .addTo(map);
                vehicleMarkers.set(id, marker);
            }
        }

        function drawRoute(routeData) {
            const { id, coordinates, color = '#3b82f6' } = routeData;
            
            if (routeLines.has(id)) {
                map.removeLayer(routeLines.get(id));
            }

            const polyline = L.polyline(coordinates, {
                color: color,
                weight: 4,
                opacity: 0.7,
                dashArray: '10, 5'
            }).addTo(map);

            routeLines.set(id, polyline);
        }

        // =========================
        // SIMULATION MODE
        // =========================
        function startSimulation() {
            // Statistiques initiales
            updateStats({
                vehicleCount: 342,
                avgSpeed: 42.3,
                emissions: 1250,
                timeSaved: 8.5
            });

            // G√©n√®re des v√©hicules simul√©s
            for (let i = 0; i < 20; i++) {
                const lat = MAP_CENTER[0] + (Math.random() - 0.5) * 0.05;
                const lng = MAP_CENTER[1] + (Math.random() - 0.5) * 0.05;
                const speed = 20 + Math.random() * 60;
                
                addOrUpdateVehicle({
                    id: i,
                    lat,
                    lng,
                    speed,
                    status: speed < 30 ? 'Fluide' : speed < 50 ? 'Dense' : 'Embouteill√©'
                });
            }

            // Route simul√©e
            const routeCoords = [
                [48.8566, 2.3522],
                [48.8606, 2.3376],
                [48.8738, 2.2950]
            ];
            drawRoute({ id: 'route1', coordinates: routeCoords, color: '#8b5cf6' });

            // Alertes initiales
            addAlert('Embouteillage pr√©vu Rue de Rivoli dans 25 minutes', 'warning');
            addAlert('Route alternative propos√©e: -12 minutes estim√©', 'info');
            addAlert('R√©duction d\'√©missions: 23% atteint', 'info');

            // Mise √† jour continue
            setInterval(() => {
                const trafficDensity = 30 + Math.random() * 50;
                updateTrafficChart(trafficDensity);
                
                // Mise √† jour al√©atoire des stats
                updateStats({
                    vehicleCount: 300 + Math.floor(Math.random() * 100),
                    avgSpeed: 35 + Math.random() * 20,
                    emissions: 1200 + Math.random() * 200,
                    timeSaved: 7 + Math.random() * 4
                });

                // Alerte al√©atoire
                if (Math.random() > 0.95) {
                    const alerts = [
                        'Congestion d√©tect√©e Boulevard Haussmann',
                        'Accident signal√© Avenue des Champs-√âlys√©es',
                        'Optimisation de route effectu√©e: +5% efficacit√©',
                        'Capteur #42 d√©connect√© - Zone non couverte'
                    ];
                    addAlert(alerts[Math.floor(Math.random() * alerts.length)], 
                            Math.random() > 0.5 ? 'warning' : 'info');
                }
            }, 3000);
        }

        function updateStats(stats) {
            document.getElementById('vehicleCount').textContent = (stats.vehicleCount || stats.totalVehicles || 0);
            document.getElementById('avgSpeed').textContent = (stats.avgSpeed || 0).toFixed(1);
            document.getElementById('emissions').textContent = (stats.emissions || 0).toFixed(0);
            document.getElementById('timeSaved').textContent = (stats.timeSaved || 0).toFixed(1);
        }

        // =========================
        // INITIALIZATION
        // =========================
        window.addEventListener('DOMContentLoaded', () => {
            initCharts();
            connectWebSocket();
        });
    </script>
</body>
</html>
